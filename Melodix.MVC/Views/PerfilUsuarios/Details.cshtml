@using Melodix.Modelos
@model Melodix.Modelos.PerfilUsuario

@{
    ViewData["Title"] = "Details";

    var yaSigue = ViewBag.YaSigueEstePerfil as bool? ?? false;
    var esMiPerfil = ViewBag.EsMiPerfil as bool? ?? false;
    var usuarioId = User?.FindFirst("sub")?.Value ??
                    User?.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value;
}


<style>
    .perfil-encabezado {
    height: 400px;
    background: linear-gradient(180deg, #444 0%, #121212 100%);
    padding: 40px 60px;
    border-radius: 12px;
    }

    .perfil-foto {
    width: 180px;
    height: 180px;
    object-fit: cover;
    border: 4px solid #121212;
    }

    .perfil-label {
    font-size: 15px;
    color: #ccc;
    }

    .perfil-nombre {
    font-size: 90px;
    font-weight: bold;
    color: white;
    }

    .perfil-bio {
    color: #ccc;
    }

    .perfil-detalles {
    color: black;
    margin-top: 1.5rem;
    padding-left: 3rem;
    padding-right: 3rem;
    }

    .boton-editar {
    background-color: #f0f0f0;
    color: black;
    font-weight: bold;
    border-radius: 25px;
    padding: 10px 24px;
    }

    .modal-foto {
    width: 120px;
    height: 120px;
    object-fit: cover;
    }
</style>

<!-- Fondo estilo Spotify -->
<div class="d-flex flex-column align-items-start justify-content-end text-white perfil-encabezado">
    <div class="d-flex align-items-center">
        <img src="@Model.FotoUrl"
        alt="Foto de perfil"
        class="rounded-circle me-4 perfil-foto" />
        <div>
            <span class="perfil-label">Perfil</span>
            <h1 class="perfil-nombre">@Model.Usuario?.Nombre</h1>
            <p class="perfil-bio">@Model.Bio</p>
            <p><strong>País:</strong> @Model.Pais</p>
            <p><strong>Fecha de nacimiento:</strong> @Model.FechaNacimiento.ToString("dd/MM/yyyy")</p>
        </div>
    </div>
</div>





<!-- Botón para abrir el modal -->
@if (ViewBag.EsMiPerfil == true)
{
    <button class="btn mt-3 boton-editar"
    data-bs-toggle="modal"
    data-bs-target="#editarModal">
        Editar perfil
    </button>
}


<!-- Modal de edición -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title fs-4" id="editarModalLabel">Detalles del perfil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Edit" asp-route-id="@Model.PerfilUsuarioId" method="post" enctype="multipart/form-data">
                    <input type="hidden" asp-for="PerfilUsuarioId" />

                    <div class="text-center mb-4">
                        <img src="@Model.FotoUrl" class="rounded-circle modal-foto" />
                    </div>

                    <div class="form-floating mb-3">
                        <input asp-for="Bio" class="form-control bg-dark text-white border-secondary" placeholder="Bio" />
                        <label asp-for="Bio" class="text-muted">Biografía</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input asp-for="FechaNacimiento" type="date" class="form-control bg-dark text-white border-secondary" placeholder="Fecha de nacimiento" />
                        <label asp-for="FechaNacimiento" class="text-muted">Fecha de nacimiento</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input asp-for="Pais" class="form-control bg-dark text-white border-secondary" placeholder="País" />
                        <label asp-for="Pais" class="text-muted">País</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nueva foto</label>
                        <input type="file" name="nuevaFoto" class="form-control" />
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--Boton para seguir un perfil de otro usuario-->
@if (!esMiPerfil)
{
    <form method="post" asp-controller="PerfilUsuarios" asp-action="SeguirPerfil">
        <input type="hidden" name="usuarioId" value="@usuarioId" />

        <input type="hidden" name="seguidoId" value="@Model.PerfilUsuarioId" />

        <button type="submit" class="btn @(yaSigue ? "btn-danger" : "btn-primary")">
            @(yaSigue ? "Dejar de seguir" : "Seguir perfil")
        </button>
    </form>


}

<!--Boton para enviar la solicitud de convertirse en artista-->
@if (ViewBag.EsMiPerfil == true && ViewBag.MostrarBotonConvertirse == true)
{
    <button class="btn btn-outline-success mt-3" data-bs-toggle="modal" data-bs-target="#modalSolicitudArtista">
        🎤 Conviértete en artista
    </button>
}



<!--Mostrar playlist en perfil-->
<hr class="my-5 text-white" />

<h3 class="text-white">Playlists públicas</h3>

@if (Model.Usuario?.Playlists != null && Model.Usuario.Playlists.Any(p => !p.EsPrivada))
{
    <div class="row">
        @foreach (var playlist in Model.Usuario.Playlists.Where(p => !p.EsPrivada))
        {
            <div class="col-md-3 mb-4">
                <div class="card bg-dark text-white shadow-sm border-secondary">
                    <img src="@playlist.ImagenUrl" class="card-img-top" style="height: 180px; object-fit: cover;" />
                    <div class="card-body text-center">
                        <h5 class="card-title">@playlist.Nombre</h5>
                        <a asp-controller="Playlists" asp-action="Details" asp-route-id="@playlist.PlaylistId" class="btn btn-outline-light btn-sm mt-2">
                            Ver playlist
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <p class="text-muted">Este usuario no tiene playlists públicas.</p>
}

<!--Mostrar artistas seguidos-->
@if (ViewBag.ArtistasSeguidos != null && ((List<Artista>)ViewBag.ArtistasSeguidos).Any())
{
    <h4 class="mt-4">Artistas que sigue</h4>
    <div class="d-flex flex-wrap gap-4">
        @foreach (var artista in (List<Artista>)ViewBag.ArtistasSeguidos)
        {
            <div class="card text-center" style="width: 150px;">
                <a asp-controller="Artistas" asp-action="Details" asp-route-id="@artista.ArtistaId">
                    <img src="@artista.ImagenUrl" class="card-img-top rounded-circle p-2" alt="Foto" />
                </a>
                <div class="card-body">
                    <p class="card-text fw-bold">@artista.NombreArtistico</p>
                </div>
            </div>
        }
    </div>
}

<!--Mostrar Usuarios seguidos-->
@if (ViewBag.UsuariosSeguidos != null && ((List<ApplicationUser>)ViewBag.UsuariosSeguidos).Any())
{
    <h4 class="mt-4">Usuarios que sigue</h4>
    <div class="d-flex flex-wrap gap-3">
        @foreach (var seguido in (List<ApplicationUser>)ViewBag.UsuariosSeguidos)
        {
            var perfil = seguido.Perfil;
            if (perfil != null)
            {
                <a asp-controller="PerfilUsuarios" asp-action="Details" asp-route-id="@seguido.Id" class="text-decoration-none text-white text-center">
                    <div style="width: 140px;">
                        <img src="@perfil.FotoUrl" class="rounded-circle mb-2" style="width: 120px;" />
                        <p>@seguido.UserName</p>
                    </div>
                </a>
            }
        }
    </div>
}
else
{
    <p class="text-muted">No sigue a ningún usuario.</p>
}

<!--Mmosrar usuarios que me siguen-->
<h4>Seguidores</h4>
@if (ViewBag.Seguidores != null && ((List<ApplicationUser>)ViewBag.Seguidores).Any())
{
    <div class="d-flex flex-wrap gap-3">
        @foreach (var user in (List<ApplicationUser>)ViewBag.Seguidores)
        {
            <a asp-controller="PerfilUsuarios" asp-action="Details" asp-route-id="@user.Id" class="text-decoration-none text-light">
                <div class="card text-center p-2" style="width: 120px;">
                    <img src="@user.Perfil?.FotoUrl" class="rounded-circle mx-auto" style="width: 70px; height: 70px;" />
                    <div class="mt-2" style="color: black;">@user.Nombre</div>


                </div>
            </a>
        }
    </div>
}
else
{
    <p class="text-muted">Este perfil aún no tiene seguidores.</p>
}

<!-- Modal flotante para crear playlist -->
<div class="modal fade" id="modalCrearPlaylist" tabindex="-1" aria-labelledby="modalCrearPlaylistLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="modalCrearPlaylistLabel">Crear nueva playlist</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form action="/Playlists/Create" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="Nombre" class="form-label">Nombre de la playlist</label>
                        <input type="text" class="form-control" name="Nombre" required />
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="EsPrivada" id="EsPrivada" />
                        <label class="form-check-label" for="EsPrivada">¿Privada?</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Seleccionar imagen (opcional)</label>
                        <input type="file" name="Imagen" class="form-control" accept="image/*" />
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-success">Crear</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Solicitud para convertirse en artista -->
<div class="modal fade" id="modalSolicitudArtista" tabindex="-1" aria-labelledby="modalSolicitudArtistaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 shadow" style="background-color: #1e1e1e; color: white;">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSolicitudArtistaLabel">Solicitud para convertirse en artista</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <form asp-action="Create" asp-controller="SolicitudesMusico" method="post">
                <div class="modal-body">

                    <div class="mb-3">
                        <label for="NombreArtistico" class="form-label">Nombre artístico</label>
                        <input type="text" class="form-control" name="NombreArtistico" required />
                    </div>

                    <div class="mb-3">
                        <label for="Distribuidora" class="form-label">Distribuidora</label>
                        <input type="text" class="form-control" name="Distribuidora" required />
                    </div>

                    <div class="mb-3">
                        <label for="Mensaje" class="form-label">Mensaje (opcional)</label>
                        <textarea class="form-control" name="Mensaje" rows="3"></textarea>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Enviar solicitud</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--Mensaje de solicitud-->
@if (TempData["Exito"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        @TempData["Exito"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}
